<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.cuiot.dmp.lease.mapper.ContractBoardMapper">
    <select id="queryArchiveNum" resultType="int">
        select count(*)
        from tb_building_archives
        where deleted = 0
          and status = 1
          and company_id = #{companyId}
    </select>

    <select id="queryHouseNum" resultType="int">
        select count(*)
        from tb_building_archives a
                     left join tb_houses_archives h on a.id = h.loupan_id
        where a.status = 1
          and a.deleted = 0
          and h.deleted = 0
          and a.company_id = #{companyId}
    </select>

    <select id="queryLeaseHouseNum" resultType="int">
        select count(*)
        from tb_contract_lease l
                     left join tb_contract_bind_info b on l.id = b.contract_id
                     left join tb_houses_archives h on b.bind_id = h.id
                     left join tb_building_archives a
                on a.id = h.loupan_id
        where l.contract_status in (13, 14, 28)
          and a.company_id = #{companyId}
    </select>

    <select id="queryUnLeaseHouseNum" resultType="int">
        select count(*)
        from tb_contract_lease l
                     left join tb_contract_bind_info b on l.id = b.contract_id
                     left join tb_houses_archives h on b.bind_id = h.id
                     left join tb_building_archives a
                on a.id = h.loupan_id
        where l.contract_status not in (13, 14, 28)
          and a.company_id = #{companyId}
    </select>

    <select id="queryLeaseContractNum" resultType="int">
        select count(*)
        from tb_contract_lease
        where deleted = 0
          and create_user in (select pk_user_id
                              from user_org
                              where pk_org_id = #{companyId})
    </select>

    <select id="queryIntentionContractNum" resultType="int">
        select count(*)
        from tb_contract_intention
        where deleted = 0
          and create_user in (select pk_user_id
                              from user_org
                              where pk_org_id = #{companyId})
    </select>

    <select id="queryLoupanBoardInfo" resultType="cn.cuiot.dmp.lease.vo.ContractBoardInfoVo">
        select loupanName, sum(leaseNum) leaseNum, sum(unleaseNum) unleaseNum
        from (
                     select a.name                                                            loupanName,
                            case when l.contract_status in (13, 14, 28) then 1 else 0 end     leaseNum,
                            case when l.contract_status not in (13, 14, 28) then 1 else 0 end unleaseNum
                     from tb_contract_lease l
                                  left join tb_contract_bind_info b on l.id = b.contract_id
                                  left join tb_houses_archives h on b.bind_id = h.id
                                  left join tb_building_archives a
                             on a.id = h.loupan_id
                     where l.deleted=0 and h.deleted=0 and h.deleted=0 and a.deleted=0 and a.company_id = #{companyId}) a
        group by a.loupanName
    </select>
</mapper>
