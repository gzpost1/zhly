<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.cuiot.dmp.baseconfig.flow.mapper.WorkInfoMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cn.cuiot.dmp.baseconfig.flow.entity.WorkInfoEntity">
        <id column="id" property="id" />
        <result column="create_time" property="createTime" />
        <result column="create_user" property="createUser" />
        <result column="business_type" property="businessType" />
        <result column="org_id" property="orgId" />
        <result column="work_name" property="workName" />
        <result column="work_souce" property="workSouce" />
        <result column="create_user" property="createUser" />
        <result column="status" property="status" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        create_time,
        create_user,
        id, business_type, org, work_name, work_souce, user_id, status
    </sql>
    <sql id="queryWorkOrderInfoSql">
        t1.id ,t1.business_type,t1.org_id,t1.work_name,t1.work_souce,t1.status,t1.create_time,t1.create_user,t1.proc_inst_id,t1.company_id,
              t2.business_type as timeOut
    </sql>
    <select id="queryWorkOrderInfo" resultType="cn.cuiot.dmp.baseconfig.flow.dto.work.WorkInfoDto">
        select  <include refid="queryWorkOrderInfoSql"/>
            from tb_work_info t1 left join (select business_type,proc_inst_id from tb_work_business_type_info WHERE business_type=1 group by proc_inst_id ,business_type) t2
        on t1.proc_inst_id = t2.proc_inst_id
          <include refid="queryWorkOrderInfoCondition"/>                                                                                                                                                                          on t1.create_user = t2.user_id
    </select>
    <sql id="queryWorkOrderInfoCondition">
        <where>
            <if test="query.id !=null">
                and t1.id like concat('%',#{query.id},'%')
            </if>
            <if test="query.businessType !=null">
                and t1.business_type = #{query.businessType}
            </if>
            <if test="query.status !=null">
                and t1.status = #{query.status}
            </if>
            <if test="query.createUser !=null">
                and t1.create_user =#{createUser}
            </if>
            <if test="query.workSouce !=null ">
                and t2.business_type =#{query.workSouce}
            </if>
            <if test="query.timeOut !=null">
                and t1.time_out =#{query.timeOut}
            </if>
            <if test="query.workName !=null">
                and t1.work_name like concat('%',#{query.workName},'%')
            </if>
            <if test="query.orgIds !=null">
                and t1.org_id in
                <foreach collection="query.orgIds" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </sql>

    <select id="queryWorkOrderDetailInfo" resultType="cn.cuiot.dmp.baseconfig.flow.dto.work.WorkInfoDto">
        select  <include refid="queryWorkOrderInfoSql"/>
            from tb_work_info t1 left join users t2 on t1.create_user = t2.user_id
            where t1.proc_inst_id = #{query.procInstId}
    </select>

    <sql id="queryMyNotApprovalSql">
        t1.proc_inst_id,t1.business_type,t1.org_id,t1.work_name,t1.work_souce,t1.create_time,t1.create_user,t1.company_id,
            t2.ID_ as task_id ,t2.TASK_DEF_ID_ as procDefId
    </sql>
    <select id="queryMyNotApproval" resultType="cn.cuiot.dmp.baseconfig.flow.dto.approval.MyApprovalResultDto">
        select
            <include refid="queryMyNotApprovalSql"/>
        from tb_work_info t1 INNER JOIN act_ru_task t2 on  t1.proc_inst_id = t2.PROC_INST_ID_
    </select>
    <sql id="queryMyNotApprovalCondition">
        <where>
            <if test="query.assignee !=null and query.assignee !=''">
                and t2.ASSIGNEE_ = #{query.assignee}
            </if>
            <if test="query.businessType !=null">
                and t1.business_type = #{query.businessType}
            </if>
            <if test="query.orgId !=null">
                and t1.org_id = #{query.orgId}
            </if>
            <if test="query.workName !=null and query.workName !=''">
                and t1.work_name like concat('%',#{query.workName},'%')
            </if>
            <if test="query.createUser !=null">
                and t1.create_user = #{query.createUser}
            </if>
            <if test="query.startTime !=null">
                and t1.create_time >= #{query.startTime} and t1.create_time <![CDATA[<=]]> #{query.endTime}
            </if>
            <if test="query.procInstId !=null">
                and t1.proc_inst_id like concat('%',#{query.procInstId},'%')
            </if>
            <if test="query.queryType !=null and query.queryType ==1">
                and t2.DELETE_REASON_ = '0'
            </if>
            <if test="query.makeUserId !=null">
                and t2.user_id = #{query.makeUserId}
            </if>
        </where>
    </sql>
    <sql id="queryMyApprovalSql">
        t1.proc_inst_id, t1.create_user, t1.status, t1.work_souce, t1.work_name,  t1.orgId, t1.business_type
            ,t1.create_time  ,t2.END_TIME_ as endTime
    </sql>
    <select id="queryMyApproval" resultType="cn.cuiot.dmp.baseconfig.flow.dto.approval.MyApprovalResultDto">
        select
            <include refid="queryMyApprovalSql"/>
        from  tb_work_info t1 INNER JOIN  act_hi_taskinst t2 on t1.proc_inst_id = t2.PROC_DEF_ID_
        <include refid="queryMyNotApprovalCondition"/>
    </select>

    <sql id="queryMakeApprovalSql">
        t1.proc_inst_id,t1.business_type,t1.org_id,t1.work_name,t1.work_souce,t1.status,t1.create_time,t1.create_user
    </sql>
    <select id="queryMakeApproval" resultType="cn.cuiot.dmp.baseconfig.flow.dto.approval.MyApprovalResultDto">
        select
            <include refid="queryMakeApprovalSql"/>
        from tb_work_info t1 INNER JOIN tb_flow_cc t2 on t1.proc_inst_id = t2.process_instance_id
        <include refid="queryMyNotApprovalCondition"/>
    </select>

    <sql id="queryMySubmitWorkInfo">
        proc_inst_id,business_type,org_id,work_name,work_souce,status,create_time,create_user
    </sql>
    <select id="queryMySubmitWorkInfo" resultType="cn.cuiot.dmp.baseconfig.flow.dto.approval.MyApprovalResultDto">
        select
        <include refid="queryMakeApprovalSql"/>
        from tb_work_info
        <include refid="queryMySubmitWorkInfoContidition"/>
    </select>
    <sql id="queryMySubmitWorkInfoContidition">
        <if test="query.businessType !=null">
            and t1.business_type = #{query.businessType}
        </if>
        <if test="query.orgId !=null">
            and t1.org_id = #{query.orgId}
        </if>
        <if test="query.workName !=null and query.workName !=''">
            and t1.work_name like concat('%',#{query.workName},'%')
        </if>
        <if test="query.createUser !=null">
            and t1.create_user = #{query.createUser}
        </if>
        <if test="query.startTime !=null">
            and t1.create_time >= #{query.startTime} and t1.create_time <![CDATA[<=]]> #{query.endTime}
        </if>
        <if test="query.procInstId !=null">
            and t1.proc_inst_id like concat('%',#{query.procInstId},'%')
        </if>
    </sql>
</mapper>
